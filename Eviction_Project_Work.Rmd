---
title: "Eviction Lab Data Exploration"
author: "Allison Shafer, Monica Puerto, Allison Ragan"
date: "12/1/2019"
output:
  word_document: default
  pdf_document:
    df_print: kable
    fig_caption: yes
    fig_height: 3
    fig_width: 4
geometry: margin=1in
fontsize: 12pt
---
```{r knitr setup, echo=FALSE}
knitr::opts_chunk$set(echo = FALSE,eval = TRUE,warning = FALSE)
```


```{r setup, include=FALSE}

# call in libraries to use
suppressMessages(library(tidyverse))
suppressMessages(library(DataExplorer))
suppressMessages(library(modelr))
suppressMessages(library(lubridate))
suppressMessages(library(stringr))
suppressMessages(library(purrr))
suppressMessages(library(gganimate))
suppressMessages(library(readxl))
suppressMessages(library(tidycensus))
suppressMessages(library(rvest))
suppressMessages(library(tmap))
suppressMessages(library(spData))
suppressMessages(library(tigris))
suppressMessages(library(sf))
suppressMessages(library(gridExtra))
suppressMessages(library(corrplot))
suppressMessages(library(factoextra))
suppressMessages(library(cluster))
suppressMessages(library(RColorBrewer))
suppressMessages(library(MASS))
suppressMessages(library(ggcorrplot))
suppressMessages(library(viridis))
suppressMessages(library(leaflet))
suppressMessages(library(spatialEco))
suppressMessages(library(sp))
```


```{r download data - eviction dataset, include=FALSE}

# set up a data directory if it does not exist already
if(!file.exists("./data")) {dir.create("./data")}

# store urls needed - right click on excel symbol and select
# copy link address
eviction_US_all <- c("https://eviction-lab-data-downloads.s3.amazonaws.com/US/all.csv")

# check to see if URL saved to variable
eviction_US_all

# download the csv file -- takes 2 to 5 minutes, maybe more over bad wifi
download.file(eviction_US_all, destfile = "./data/eviction_US_all.csv", mode = "wb") 

# read the csv file into R and save into dataframe
eviction_US_all <- read_csv("./data/eviction_US_all.csv")

# replacing "-" in column names
names(eviction_US_all) <- gsub(x = names(eviction_US_all), pattern = "-", replacement = "_")  
```

```{r import rural urban, include=FALSE}

# download and load urbal/rural classifications

# set up a data directory if it does not exist already
if(!file.exists("./data")) {dir.create("./data")}

# store urls needed - right click on excel symbol and select
# copy link address
urban_rural <- c("http://www2.census.gov/geo/docs/reference/ua/County_Rural_Lookup.xlsx")

# download the .xlsx file

download.file(urban_rural, destfile = "./data/urban_rural.xlsx", mode = "wb")

# read xlsx into R

urban_rural <- read_excel(skip = 3, "./data/urban_rural.xlsx")


# clean data set
urban_rural <- urban_rural %>%
  rename("Percent_Rural" = "2010 Census \r\nPercent Rural",
         "GEOID" = "2015 GEOID")


# create Rural Flag where Ruran Percentage is greater than 50%
urban_rural <-urban_rural %>%
  mutate(rural_flag = ifelse(round(Percent_Rural, 3) > 50, 1, 0)) %>%
  dplyr::select(GEOID, State, Percent_Rural, rural_flag)

```

```{r Webscrape US Labor Stats, include=FALSE}
if(!file.exists("./data/labor_data")) {dir.create("./data/labor_data")}

# save url into a variable
url <- "https://www.bls.gov/lau/#tables"

# download the html content using read_html
download.file(url,destfile="./data/uslabor.html")
us_county_labor_html <- read_html("./data/uslabor.html")

# extract the xslx
us_county_labor_html %>%
   rvest::html_nodes("ul") %>%
        rvest::html_nodes("li") %>%
        rvest::html_nodes("a") %>%
        rvest::html_attr("href") %>%
        str_subset(".xlsx$") -> us_labor_urls

# domain
domain <- "https://www.bls.gov"

# paste domain to urls
str_c(domain,us_labor_urls) -> us_labor_urls

# only need years from 2000 to 2016
us_labor_urls[3:19] -> us_labor_2000_2016
years <- rep(2000:2016,1)

# a for loop that downloads each file
for(i in seq_along(us_labor_2000_2016)){
  download.file(us_labor_2000_2016[i],destfile = paste("./data/labor_data/",years[i],".xslx",sep=""),mode="wb")
}

# save the files pertaining to us labor
labor_files <- dir("./data/labor_data")


# create a function that downloads each url and saves it #into a dataframe
read_files <- function(x){
read_excel(path= paste("./data/labor_data/",x,sep=""),skip = 7,col_names = c("laus_code","state_fips_code","county_fips_code","county_name","year","","labor_force","employed","unemployed","unemployment_rate"),sheet = 1,na="")
}

# map the function to read each file
map(labor_files,read_files) -> all_labor_data

# join all the US labor tables
all_labor_data %>% reduce(full_join) -> all_labor_data

# remove some rows that have NA in Year and remove empty column next to year
filter(all_labor_data,!is.na(year)) %>% dplyr::select(-6) -> all_labor_data
```


``` {r small data transformations, include=FALSE}

# creating a GEOID to join
all_labor_data$GEOID <- str_c(all_labor_data$state_fips_code,all_labor_data$county_fips_code)

# change year to integer
all_labor_data$year <- as.integer(all_labor_data$year)

```


```{r download county spatial data, include=FALSE}

# set up a data directory if it does not exist already
if(!file.exists("./data")) {dir.create("./data")}

# download county shapefiles
download.file("https://www2.census.gov/geo/tiger/GENZ2018/shp/cb_2018_us_county_500k.zip", destfile = "./data/county_shp.zip")

spatial_data <- "./data/county_shp.zip"

unzip(spatial_data, overwrite = TRUE, exdir = "./data/spatial/county_shp")

county_boundaries <- st_read("./data/spatial/county_shp/cb_2018_us_county_500k.shp")


```

```{r make county dataset, include=FALSE}
# County Table joined with 2 additional variables : rural flag and unemployment rate

eviction_county <- eviction_US_all %>%
  right_join(urban_rural, key = "GEOID") %>%
  left_join(dplyr::select(all_labor_data,GEOID,year,unemployment_rate), by =c("GEOID" = "GEOID", "year"="year"))

```

```{r make state dataset, include=FALSE}

eviction_state <- eviction_US_all %>%
  filter(nchar(GEOID) == 2)


```

```{r make region column,warning=FALSE, include=FALSE}
states_regions <- as.data.frame(cbind("states"= state.name,"region"=state.region))# creating state and region table
# names(states_regions) <- c("states","region")
# recode regions
region_names <- c("1" = "Northeast", "2" = "South", "3" = "North Central","4"="West")
recode(states_regions$region, !!!region_names) -> states_regions$region

left_join(eviction_state, states_regions, by = c("name"="states")) -> eviction_state

left_join(eviction_county, states_regions,by = c("parent_location"="states")) -> eviction_county

# dplyr::select(eviction_county,parent_location,region) %>% unique() #check if joined right
# Need to replace DC with a region
eviction_county$region[eviction_county$name == "District of Columbia"] <- "South"

# remove rows with no region
eviction_county %>% drop_na(name) -> eviction_county
```

```{r make pct_non_white column for county, include=FALSE}
eviction_county$pct_nonwhite <- 100 - eviction_county$pct_white
```

```{r removing 2009 and earlier and non continental US, include=FALSE}
eviction_county_2010 <- eviction_county %>%
  filter(year >= 2010) %>%
  mutate(rural_flag = as.character(rural_flag)) %>%
  filter(!State %in% c('AK', 'HI'))

eviction_state_2010 <- eviction_state %>%
  filter(year >= 2010) %>%
  filter(!GEOID %in% c('02', '15', '60', '66', '69', '72', '78'))
```

```{r K-means creating cluster, include=FALSE}
km <- eviction_county_2010 %>%
  group_by(GEOID) %>%
  mutate(average_population = mean(population, na.rm = TRUE),
         average_poverty_rate = mean(poverty_rate, na.rm = TRUE),
         average_pct_renter_occupied = mean(pct_renter_occupied, na.rm = TRUE),
         average_median_gross_rent = mean(median_gross_rent, na.rm = TRUE),
         average_median_household_income = mean(median_household_income, na.rm = TRUE),
         average_median_property_value = mean(median_property_value, na.rm = TRUE),
         average_rent_burden = mean(rent_burden, na.rm = TRUE),
         average_pct_white = mean(pct_white, na.rm = TRUE),
         average_pct_af_am = mean(pct_af_am, na.rm = TRUE),
         average_pct_hispanic = mean(pct_hispanic, na.rm = TRUE),
         average_pct_am_ind = mean(pct_am_ind, na.rm = TRUE),
         average_pct_asian = mean(pct_asian, na.rm = TRUE),
         average_pct_nh_pi = mean(pct_nh_pi, na.rm = TRUE),
         average_pct_multiple = mean(pct_multiple, na.rm = TRUE),
         average_pct_other = mean(pct_other, na.rm = TRUE),
         average_Percent_Rural = mean(Percent_Rural, na.rm = TRUE),
         average_unemployment_rate = mean(unemployment_rate, na.rm = TRUE),
         average_pct_nonwhite = mean(pct_nonwhite, na.rm = TRUE))
  # filter(State != "AK" & State != "HI")
km <- subset(km, select = c("GEOID", "average_population", "average_poverty_rate", "average_pct_renter_occupied", "average_median_gross_rent", "average_median_household_income", "average_median_property_value", "average_rent_burden", "average_pct_white", "average_pct_af_am", "average_pct_hispanic", "average_pct_am_ind", "average_pct_asian", "average_pct_nh_pi", "average_pct_multiple", "average_pct_other", "average_Percent_Rural", "average_unemployment_rate", "average_pct_nonwhite" ))
# dedupe and drop nulls
km <- km %>%
  distinct() %>% # reduces to 3147
  drop_na() # reduces to 3138
# set GEOID (chr.) to index
km <- km %>%
  column_to_rownames(., var = "GEOID")
km_sc <- km
# scale numerical data
ind <- sapply(km_sc, is.numeric)
km_sc[ind] <- lapply(km_sc[ind], scale)
# determine optimal clusters
# elbow
set.seed(123)
#fviz_nbclust(km_sc, kmeans, method = "wss") # 3
# silhouette
#fviz_nbclust(km_sc, kmeans, method = "silhouette") # 3
# Results
final <- kmeans(km_sc, 3, nstart = 25, algorithm = "Hartigan-Wong")
#fviz_cluster(final, data = km_sc)

# Extract clusters and add to data frame
km$cluster <- final$cluster

# reintroduce GEOID as column
km$GEOID <- c(row.names(km))
# reset index
rownames(km) <- NULL
km <- km %>%
  dplyr::select(GEOID, everything())
```

```{r merge back K-means clusters to county dataset, include=FALSE}
geo_clust <- subset(km, select = c("GEOID", "cluster"))
eviction_county_2010 <- merge(eviction_county_2010, geo_clust)
eviction_county_2010$cluster <- as.character(eviction_county_2010$cluster)

# Add county name column
eviction_county_2010$county_state <- str_c(tools::toTitleCase(as.character(eviction_county_2010$name)),
                                           eviction_county_2010$parent_location, sep = ", ")
```

```{r creating spatial datasets for state, include=FALSE}

# get Census TIGER shapefiles for state
state_us_geo <- tigris::states(class= "sf")


# add spatial data to the state level eviction data

eviction_by_state <- eviction_state_2010 %>%
                    left_join(state_us_geo, c("GEOID" = "GEOID")) %>%
                    dplyr::select(-LSAD, -MTFCC, -FUNCSTAT, -STUSPS, -STATENS)

```


```{r set up spatial datasets - state level, include=FALSE}

# test reading in csv
eviction_by_state <- eviction_state_2010

# create spatial datasets for state
state_us_geo <- tigris::states(class= "sf")

#convert to a SpatialPolygonDataFrame
spatial_state <- as_Spatial(state_us_geo)


#Join in state eviction data
state_eviction <- sp::merge(spatial_state, eviction_by_state, by = c("GEOID" = "GEOID"), duplicateGeoms = TRUE)

as.data.frame(state_eviction) %>%
  arrange(STATEFP) %>%
  filter(name == "South Dakota") %>%
  arrange(year)

#Remove NAs for mapping application
#state_eviction <- sp.na.omit(state_eviction, col.name = )

```

```{r setup spatial datasets - county level, include=FALSE}

# add spatial data to the county level eviction data
sp_eviction_county <- county_boundaries %>%
                      left_join(eviction_county_2010, c("GEOID" = "GEOID"))

# ensure spatial data was added
sp_eviction_county

# create field for average filing rate and keep only entities in the continental US
filing_by_county <- sp_eviction_county %>%
                     group_by(GEOID) %>%
                     summarise(avg_filing_rate = mean(eviction_filing_rate, 
                                                      na.rm = TRUE))
# look at fields in dataset
names(filing_by_county)

# merge field into eviction_county table
filing_avg_county <- merge(filing_by_county, eviction_county_2010, by = "GEOID")

# look at fields in dataset
names(filing_avg_county)

# create a table with all field averages.
county_all_avgs <- filing_avg_county %>%
                            group_by(GEOID) %>%
                            summarise_if(is.numeric, mean, na.rm = TRUE) %>%
                            mutate_at(2:28, funs(round(., 0)))

# confirm dataset is spatial
county_all_avgs

```

```{r Create grouped spatial data tables for analysis, echo=FALSE}

# Create average filing rate by state table
filing_by_state <- state_us_geo %>%
                   right_join(eviction_state_2010, by = "GEOID") %>%
                    group_by(GEOID) %>%
                    summarise(avg_filing_rate = mean(eviction_filing_rate, 
                                                      na.rm = TRUE))
# merge new field into table
filing_avg_state <- merge(filing_by_state, eviction_state_2010,  by="GEOID")

# create averages for all numeric fields in dataset
state_all_avgs <- filing_avg_state %>%
                            group_by(GEOID) %>%
                            summarise_if(is.numeric, mean, na.rm = TRUE) %>%
                            mutate_at(2:26, funs(round(., 0)))

# Create state name field
state_names <- eviction_state_2010 %>%
                group_by(GEOID, name) %>%
                dplyr::select(GEOID, name) %>%
                distinct()


# Add state name field into table             
state_all_avgs <- state_all_avgs %>%
  left_join(state_names, by = "GEOID") %>%
  dplyr::select(GEOID, name, everything()) 


df_allavg_st <- as.data.frame(state_all_avgs)
```

```{r create data breaks for symbology- state map, include=FALSE}

pretty_breaks <- c(5, 10, 15, 20, 25, 65)
# find the extremes
minVal <- min(state_all_avgs$avg_filing_rate, na.rm = T)
# compute labels
labels <- c()
brks <- c(minVal, pretty_breaks)
# round the labels (actually, only the extremes)
for(idx in 1:length(brks)){
  labels <- c(labels,round(brks[idx + 1], 2))
}

labels <- labels[1:length(labels)-1]
# define a new variable on the data set just as above
state_all_avgs$brks <- cut(state_all_avgs$avg_filing_rate, 
                     breaks = brks, 
                     include.lowest = TRUE, 
                     labels = labels)

brks_scale <- levels(state_all_avgs$brks)
labels_scale <- rev(brks_scale)

state_all_avgs$brks

state_all_avgs$geometry

```

```{r write csvs for Shiny App, include=FALSE}
write_csv(eviction_by_state,path = "./data/eviction_by_state.csv")
write_csv(eviction_county_2010,path = "./data/eviction_county_2010.csv")
```


```{r, include=FALSE}
#In case above broke and did not run if you have Windows use the Load R Data
#load(".RData")
```

  
  For our group project, we analyzed data from The Eviction Lab to answer our posed questions regarding which attributes are most associated with eviction filing rates and whom is most affected by evictions.  Eviction filing rates varied greatly by region with the Northeast and the South regions experiencing one to two times higher eviction filing rates compared to the West and North Central regions. Comparing the eviction filing rate averages, the last few years of the dataset ending in 2016, the Northeast region has seen the steepest decline starting in 2013 compared to the rest of the regions, whereas the South has remained flat, and in the North Central and West regions have declined since 2012, but the West saw a slight increase in 2016. Drilling into the change by Counties, the South as a region remained flat because there are many counties who experience an increase being offset by many counties in the South decreasing. 
  
```{r Region Trend Eviction Filing Rate, echo=FALSE, fig.height=5,fig.width=8}
grid.arrange(dplyr::select(eviction_county_2010, region,eviction_filing_rate, year) %>%
  #filter(year>2009) %>%
  group_by(year,region) %>%
  summarise_all(mean,na.rm=TRUE) %>%
  ggplot(aes(year,eviction_filing_rate,color = region)) +
  geom_line() + 
  scale_x_continuous(breaks=seq(2009,2016,1)) + 
  theme_minimal() + 
  ggtitle("Average Regional Eviction Filing Rate by year") +
  scale_color_brewer(palette = "Spectral"),
dplyr::select(eviction_county_2010, region,eviction_filing_rate, year) %>%
  filter(year > 2010) %>% #have to have even amount of years
  na.omit() %>%
  mutate(year_bin = ifelse(year > 2014,"y2014_2016","y2011_2013")) %>%
  dplyr::select(region,year_bin, eviction_filing_rate) %>%
  group_by(region,year_bin) %>%
  summarise_all(mean,na.rm=TRUE) %>%
  pivot_wider(names_from = "year_bin",values_from = "eviction_filing_rate") %>%
  mutate(delta = y2014_2016 - y2011_2013) %>%
  ggplot(aes(region,delta,fill=delta)) +
  geom_bar(stat="identity") +
  theme_minimal() +
  scale_color_brewer(palette = "Spectral") +
  ggtitle("Average Eviction Delta of 2014-2016 vs 2011-2013"))
```
  
  
```{r, echo=FALSE}
dplyr::select(eviction_county_2010, name,eviction_filing_rate, year,region) %>%
  filter(year > 2010) %>% #have to have even amount of years
  na.omit() %>%
  mutate(year_bin = ifelse(year > 2014,"y2014_2016","y2011_2013")) %>%
  dplyr::select(name,year_bin, eviction_filing_rate,region) %>%
  group_by(name,year_bin,region) %>%
  summarise_all(mean,na.rm=TRUE) %>%
  pivot_wider(names_from = "year_bin",values_from = "eviction_filing_rate") %>%
  mutate(delta = y2014_2016 - y2011_2013) %>%
  arrange(desc(abs(delta))) %>%
  #head(50) %>%
  ggplot(aes(name,delta,fill=region)) +
  geom_bar(stat="identity") +
  theme_minimal() +
  scale_color_brewer(palette = "Spectral") +
  ggtitle("Average Eviction Delta of Counties by Region 2014-2016 vs 2011-2013") + 
    facet_wrap(~region) +
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank()) 
 #+ 
  #theme(axis.text.x = element_text(angle = 90, hjust = 1)) 
```

Additionally, the attributes that had the highest positive correlations with eviction filing rates were the percent of African American population and median gross rent. Eviction filing rates were also positively correlated with rent burden, renting costs, and percent of renter occupied. Eviction filing rates were negatively correlated with the percent of white population and the percent rural area. Areas that were more rural had less diversity and lower renter occupancy rates therefore saw less filing eviction rates. Areas that had more ethnic diversity, were more populated, and had higher renter occupancy percentages with higher rental costs saw higher eviction filing rates.


```{r Correlation Matrix, echo=FALSE}
spectral <- c(brewer.pal(11, "Spectral"))
#plot_correlation(na.omit(eviction_county), maxcat = 5L)
na.omit(eviction_county) %>%
filter(year>2009) %>%
mutate(GEOID = as.numeric(GEOID)) %>%
select_if(is.numeric) %>%
group_by(GEOID) %>%
  summarise_all(mean,na.rm=TRUE) %>% 
  as.matrix() %>% cor()  -> cor_matrix
#corrplot1
corrplot(cor_matrix[,1:nrow(cor_matrix)][1:nrow(cor_matrix),22, drop=FALSE], cl.pos='n',cl.ratio = .2, method = "number", tl.srt = 45,tl.col = "black",col = spectral[1:4],tl.cex = .8)
#corrplot 2
corrplot(cor_matrix, type="upper", order="hclust", sig.level = 0.01, insig = "blank",tl.srt = 45,tl.col = "black",cl.ratio = .2,tl.cex = .4)
#corrplot 3
# ggcorrplot(cor_matrix[,1:nrow(cor_matrix)][1:nrow(cor_matrix),22, drop=FALSE], sig.level=0.05, lab_size = 4.5, p.mat = NULL, 
#            insig = c("pch", "blank"), pch = 1, pch.col = "black", pch.cex =1,
#            tl.cex = 8) +
#   theme(axis.text.x = element_text(margin=margin(-2,0,0,0)),  # Order: top, right, bottom, left
#         axis.text.y = element_text(margin=margin(0,-2,0,0))) 
```

The Eviction Lab dataset came from a department at Princeton University called The Eviction Lab. They collected, geocoded, aggregated, cleaned, and publicized a massive dataset consisting of 82.9 million court records that occurred in the United States during 2000-2016. [The Freedom of Information Act (FOIA)](https://www.foia.gov/about.html), allows any citizen to request access to records from any federal agency. Through bulk data requests from 13 states, the Eviction Lab was able to acquire 12.8 million individual court-ordered eviction records. The rest, around 66 million records were purchased from the services of [LexisNexis](https://www.lexisnexis.com/en-us/about-us/about-us.page) and about 11 million from [American Information Research Services Inc (AIRS)](https://www.amer-info.com/about-airs/).
The Eviction Lab then treated each observation at the household level versus the individual level, so if there were two people in the case record, it would be counted as one case record per household versus one case record per person in the eviction case record. Also, commercial evictions were excluded from these court records and focused solely on cases that occurred in addresses with rental leases. In the end, the Eviction Lab team ended with around 38 million unique case records. The Eviction Lab then supplemented the eviction data with Census Bureau data by joining the datasets by zip code. The Census Bureau data included were variables like population, Geographic ID (GEOID), demographic percentages, income levels, rental variables (percent renter-occupied, median gross rent), etc.  

The Eviction Lab dataset we started our analysis with included 5,501,283 observations with 27 variables, and included data for the years 2000-2016. The data included information for all levels of counties including state, county, incorporated place, and minor civil divisions, as well as for Census tracts and block groups. The dataset was mostly ‘tidy’, but we ended up adding more variables from different datasets that needed tidying to be joined and we then segmented further for analysis. After our initial look at the data, we decided as a group that we wanted to focus our analysis on the state level countiess and county level countiess. We based this decision on a few observations from our initial exploratory data analysis. First, the more granular the data were the more null values we encountered; at the county level, our variable of interest, eviction rate, had around 23% null values. If the data was anymore granular, we would encounter higher percentages of null values in our variables of interest for areas when looking at lower counties levels. For the purposes of analyzing data correlations and or using the data for modeling, we did not want a lack of data to be an issue.


```{r Chunk Nulls Exploration, echo=FALSE}
#We have 22.5% missing of eviction rate data in county and 11% missing in state. ALl 
plot_missing(eviction_state,title = "Missing Data in Eviction States Table",ggtheme = theme_minimal(),list(Good = 0.02, OK = 0.1, Bad = 0.2,Remove=.3))
plot_missing(eviction_county,title = "Missing Data in Eviction County Table",ggtheme = theme_minimal(),list(Good = 0.02, OK = 0.1, Bad = 0.2,Remove=.3))

```

Second, we decided we were interested in incorporating additional data that was not included in our dataset, such as unemployment rates, regional information, and an indicator of whether a counties was considered rural, to determine if these variables impacted the eviction related data. During our research for additional data, we noticed that most of the datasets we were searching for were most frequently tabulated at the county level. Additionally, most of the resources included the same primary key representing the geographic code for the counties, the GEOID, that was present in the Eviction Lab dataset. 

To obtain the unemployment rate data, we used webscraping methods and built functions to download  and aggregate unemployment rate data which was organized in multiple Excel workbooks by year, from the [United State Bureau of Labor Statistics website](https://www.bls.gov/lau/#tables). In order to join the unemployment rate data to our dataset, we had to create the primary key of GEOID for the unemployment rate data. We did this by concatenating the state and county FIPS codes. For the rural indicator, we obtained data that featured the percent rural area from the Census Bureau which was tabulated based off of 2010 Census data. Using the provided percent rural field, we created a field to indicate whether we would consider the counties as rural or not. We used a threshold of 50% or more for the percent rural field to classify the counties as rural. We then joined this data to our dataset using the primary key, GEOID. Lastly, we used a built in R dataset called United States Figures and Facts containing region names (Northeast, North Central, South, and West) to identify the regions for analysis, which we joined into our dataset by state name.

We also decided that since we were analyzing data for the various levels of counties in the country, we wanted to visualize our dataset using maps. In order to create the maps, we needed to acquire geospatial data or shapefiles. We used a package in R called Tigris to obtain the shapefiles for the states, however the Tigris option for using the county level data was not working properly so we had to seek alternative resources. For the county level spatial data, we downloaded shapefiles from the Census Bureau. We then had to join the spatial datasets to our datasets to be able to display the data using a choropleth map. We completed additional spatial data manipulations to get the data in a SpatialPolygonDataframe dataframe to utilize the data with the Leaflet package for our Shiny application.

In addition to joining outside datasets to our dataset, we added a handful of extra columns using the existing data. We created a column called ‘percent non-white’ which subtracted one minus the percetange of white population. We also created a column that assigned a cluster to a county using a K-means model. 

Another main decision we made early on was to split the dataset into two, one representing the state level data and one representing the county level data. We planned on using the state level data for higher level analysis as well as summary and descriptive statistics and wanted to use the county level data for a K-means model. Our goal was to see if the counties that were in similar clusters also share similar eviction filing rates, or if there were any unexplained relationships not captured by our data.

For the K-means model, we averaged the data over the years by county so that we were left with one unique row for each county. We then scaled the data to make the variables comparable across the same scale. We excluded eviction filing rates and location data from the model, feeding in the Census Bureau data, the unemployment rate, and housing data.

One downside of using K-means to cluster counties is that the k or number of clusters must be specified in advance, but we used both the elbow method and the silhouette method to recommend the optimal amount of clusters. Both determined that 3 is the optimal amount of clusters so we built a K-means model using the Hartigan-Wong algorithm with 3 clusters


```{r Kmeans visuals , echo=FALSE}
fviz_nbclust(km_sc, kmeans, method = "wss") # 3
# silhouette
fviz_nbclust(km_sc, kmeans, method = "silhouette") # 3
# Results
fviz_cluster(final, data = km_sc)
```

When exploring the data by visualizing and summarizing data, one of our initial discoveries was  four states, South Dakota, North Dakota, Alaska, and Arkansas, did not have eviction rate data because the Eviction Lab team decided to only include county data and derive estimates from counties that had at least two consecutive years worth of data. Because of this, we decided to focus our analysis on the eviction filing rate instead. 
```{r Check if any states missing Evictions, include=FALSE}
eviction_state %>% group_by(GEOID,name) %>% summarise_at(c("eviction_filings", "evictions"), sum, na.rm = TRUE) %>% filter(evictions == 0) -> null_states
grid.arrange(tableGrob(null_states))
```

After analyzing our main variable of interest, eviction filing rate, we realized that the percentage of null eviction filing rate values at the county level averaged around 17% from 2000 to 2010, and dropped to 13% after 2010, while the state level averaged around 6% null values for 2000-2010, and dropped to less than 1% of null values for data from 2010-2016. Therefore, we decided to subset the data from 2010 onwards for both state and counties.


```{r Check pct counties with complete eviction filing by year, echo=FALSE,include=FALSE}
dplyr::select(eviction_county,GEOID,year,eviction_filing_rate) %>% 
  filter(!is.na(GEOID)) %>%
  pivot_wider(names_from=year,values_from = eviction_filing_rate) -> pivot_wider_years
data.frame("pct_eviction_rate_null" = colSums(is.na(pivot_wider_years))/3146)-> years_null
rownames_to_column(years_null,var="year") -> years_null
subset(years_null,pct_eviction_rate_null != 0) %>%
  subset(pct_eviction_rate_null != 1) %>%
  ggplot(aes(year,pct_eviction_rate_null)) +
  geom_bar(stat = "identity",fill=spectral[1]) +
  theme_classic() +
  ggtitle("% of Counties with Null Eviction Filing Rate by Year")
```

Starting with a higher level of analysis by reviewing the state level data, we used the newly altered dataset to analyze the eviction filing rate by state, it was apparent that the highest eviction filing rate for all seven years was in Maryland, with South Carolina having the second highest Eviction Filing Rate all seven years. 

```{r EDA state level data, echo=FALSE}
# look at 2016 
eviction_state_2010 %>%
  filter(year == 2016) %>%
  ggplot(aes(x = reorder(name, eviction_filing_rate), y = eviction_filing_rate, 
             fill = rent_burden)) +
  scale_fill_distiller(palette = "YlGnBu", direction = 1) +
  geom_bar(stat = 'identity', width = .75) +
  coord_flip() +
  theme(axis.text.y = element_text(size = 7)) +
  ggtitle("Eviction Filing Rate by State") +
  labs(fill = "% Rent Burden") +
  ylab("Eviction Filing Rate") +
  xlab("State")
```

```{r ggplot for static maps, echo=FALSE}

# map eviction filing rate by state

ggplot(data = state_all_avgs) +
  geom_sf(aes(fill = brks), color = "black", lwd = 0.03) +
  coord_sf(crs = st_crs(102003)) +
  theme(legend.position = "bottom") +
  scale_fill_manual(values = rev(viridis(6)), 
                  breaks = rev(brks_scale), 
                  labels = labels_scale, 
                  name = "Average Eviction Filing Rate", 
                  guide = guide_legend(
                        direction = "horizontal",
                        keyheight = unit(2, units = "mm"),
                        keywidth = unit(70 / length(labels), units = "mm"),
                        title.position = 'top',
                        title.hjust = 0.5,
                        label.hjust = 1,
                        nrow = 1,
                        byrow = T,
                        reverse = T,
                        label.position = "bottom")) +
  ggtitle("Average Eviction Filing Rate by State") +
  theme(panel.grid.major = element_line(colour = 'transparent'),
        plot.title = element_text(hjust = 0.5),
  axis.title.x=element_blank(), 
  axis.text.x=element_blank(),
  axis.ticks.x=element_blank(),
  axis.title.y=element_blank(), 
  axis.text.y=element_blank(),
  axis.ticks.y=element_blank(),
  panel.background=element_blank(),
  panel.border=element_blank(),
  panel.grid.minor=element_blank(),
  plot.background=element_blank())

```

Looking at the  distribution of eviction filing rates, the median average eviction filing rates per county from 2010-2016 were around 3.00 percent with a heavy right tail skew with a frequency of about 250 counties. There were over 200 counties with averages during this time period that experienced average eviction filing rates that ranged from 20 to 50. 

```{r EDA county - eviction rate, echo=FALSE}
# get top 100 counties with highest average evistion rate
# eviction_county %>%
#   group_by(GEOID) %>%
#   summarise(
#     avg_rate = mean(eviction_filing_rate, na.rm = TRUE)
#   ) %>%
#   top_n(100) %>%
#   arrange(desc(avg_rate))
# histogram of eviction rates in county dataset
eviction_county %>%
  filter(year >2009) %>%
  group_by(eviction_filing_rate) %>%
  count() %>%
  ggplot(aes(eviction_filing_rate)) +
  geom_histogram(bins = 50,fill=spectral[4]) +
  #scale_x_continuous(limits=c(0,90)) +
  theme_minimal() +
  scale_x_continuous(breaks=seq(0,200,5)) +
  ggtitle("Distribution of Average Eviction Filing Rate 2010-2016") +
  ylab("Count of Counties") +
  xlab("Average Eviction Filing Rate per County") +
  geom_vline(aes(xintercept=3.17),
               linetype="dashed", size=1)
```

The top ten counties with average eviction rates over the span of the seven years, all belonged to the Southern region with Prince George’s County, Maryland experiencing over 100.00 average eviction filing rates. There are several reasons why we think Maryland has the highest and eviction filing rates over 100. One, according to the Eviction Lab's Methodology Report most jurisdictions start with an out of court notice, whereas Maryland starts immediately with an eviction filing in court. Additionally, as of 2006 landlords can electronically start an eviction filing in Maryland on [Maryland's District Courts website](https://www.courts.state.md.us/district/efile/efilemain). Lastly, Maryland has greater diversity than most of the country with the state being home to ~50% non-whites compared to the [national average](https://www.census.gov/quickfacts/fact/table/US/PST045218) of 24% non-white. 

```{r top_10_trend, echo=FALSE}
# top and bottom 20 overall counties -- colored by region
ecplot <- eviction_county_2010 %>%
  group_by(GEOID) %>% 
  mutate(avg_ev_fl_rate = mean(eviction_filing_rate, na.rm=TRUE)) %>% 
  filter(avg_ev_fl_rate >= 0.01) %>%
  filter(State != "AK" & State != "HI") 

# # Create column for county + state
# ecplot$County <- str_c(tools::toTitleCase(ecplot$name), ecplot$State, sep = ", ")

# functions to calculate top/bottom rates
calc_top <- function(df, n) {
  df <- df %>%
    group_by(GEOID) %>%
    arrange(desc(avg_ev_fl_rate)) 
  result <- c(unique(df$GEOID))[1:n]
  return(result)
}
calc_bot <- function(df, n) {
  df <- df %>%
    group_by(GEOID) %>%
    arrange(avg_ev_fl_rate)
  result <- c(unique(df$GEOID))[1:n]
  return(result)
}

top_ec <- calc_top(df=ecplot, n=10)
bot_ec <- calc_bot(df=ecplot, n=10)

# functions to plot trend over time
plot_time <- function(df, vlist, hl) {
  df %>% 
  filter(GEOID %in% vlist) %>% 
  ggplot() +
  geom_line(aes(x = year, 
                y = eviction_filing_rate, 
                group = GEOID, 
                color = county_state)) +
  xlab("Year") +
  ylab("Eviction Filing Rates") +
  theme(plot.title = element_text(hjust = 0.5)) +
  labs(title = paste(hl, "Filing Counties Over Time"),
       caption = "Data from evictionlab.org") + 
  scale_color_brewer(palette = "Spectral") +
  theme_bw()
}
plot_time(ecplot, top_ec, "Highest")
# plot_time(ecplot, bot_ec, "Lowest")
```


Maryland also experienced a 19% increase in poverty rate from the 1990s to 2016, while seeing a 25% increase in population during that same time according to Washington Top News. Prince George County’s according to our K-means model is similar to San Bernardino County, CA with similar percentages of renter occupied rates, median gross rent, rent burden rates, and property values. San Bernardino County, however, had an even higher poverty rate and higher population, but had a much smaller average eviction filing rate with 6% versus 112%. This shows that there might be something missing from the data that is not being captured in this disparity. The only stark difference in this data from these counties is Prince George’s County has about ⅓ more of people of color. 

According to an article in [The News & Advance](https://www.newsadvance.com/news/local/three-households-threatened-with-eviction-every-day-in-lynchburg/article_f25bbfa8-8ef9-524c-b745-d5c13db5b258.html), Lynchburg, Virginia experienced high eviction rates. The article explained that most tenants do not go through with the court order and end up leaving because they are worried about the uphill legal battle or the repercussions--most landlords will refuse to rent to formerly evicted residents. From 2008 to 2017, 60% of 21,000 eviction suits were in favor of the landlord whereas the rest were dismissed and less than 1% were won in favor of the tenants. After the Eviction Lab data came out, according to the same article, laws have been passed to help tackle the high eviction rates Virginia has been experiencing. In the above chart visualizing the top ten counties by average eviction filing rates during 2010-2016, four of them belonged to Virginia.

Marion County, South Carolina was the only one out of the top highest average eviction filing rate counties that was predominantly rural. Marion County, similar populations, poverty rates, unemployment rates, and renter occupied rates had stark different eviction rates.

```{r,echo=FALSE}
# functions to plot trend over time -- coloring by rural flag
plot_time_rural <- function(df, vlist, hl) {
  df %>% 
  filter(GEOID %in% vlist) %>% 
  ggplot() +
  geom_line(aes(x = year, 
                y = eviction_filing_rate, 
                group = GEOID, 
                color = rural_flag)) +
  xlab("Year") +
  ylab("Eviction Filing Rates") +
  theme(plot.title = element_text(hjust = 0.5)) +
  labs(title = paste(hl, "Filing Counties Over Time"),
       caption = "Data from evictionlab.org") + 
  scale_color_manual(values=c(spectral[1], spectral[9])) +
  theme_bw()
}
 plot_time_rural(ecplot, top_ec, "Highest")
# plot_time_rural(ecplot, bot_ec, "Lowest")
```

The top ten filing counties by regions also seemed to center around the same state, with nine out of the ten highest eviction filing North Central counties all belonging to Michigan. Nine out of the top counties in Northeast all belonged to New Jersey. The top ten western counties were spread out across three states, Colorado, New Mexico, and Nevada, versus a common one. Across the regions, most of the counties with the top eviction filing rates have experienced a decline since 2010, except Lyon County in Nevada, Arapahoe County in Colorado, and Marion County in Indiana.


```{r trends_region, echo=FALSE}
# Calculate top and bottom by region
calc_top_reg <- function(df, reg, n) {
  new_df <- df %>%
    filter(region == reg) %>%
    group_by(GEOID) %>%
    arrange(desc(avg_ev_fl_rate))
  res <- c(unique(new_df$GEOID))[1:n]
  return(res)
}
calc_bot_reg <- function(df, reg, n) {
  new_df <- df %>%
    filter(region == reg) %>%
    group_by(GEOID) %>%
    arrange(avg_ev_fl_rate)
  res <- c(unique(new_df$GEOID))[1:n]
  return(res)
}

top_south <- calc_top_reg(ecplot, "South", 10)
bot_south <- calc_bot_reg(ecplot, "South", 10)
top_northeast <- calc_top_reg(ecplot, "Northeast", 10)
bot_northeast <- calc_bot_reg(ecplot, "Northeast", 10)
top_north_cent <- calc_top_reg(ecplot, "North Central", 10)
bot_north_cent <- calc_bot_reg(ecplot, "North Central", 10)
top_west <- calc_top_reg(ecplot, "West", 10)
bot_west <- calc_bot_reg(ecplot, "West", 10)


# Plot top and bottom counties by region
reg_plot <- function(df, reglist, hv, reg) {
  df %>%
    filter(GEOID %in% reglist) %>%
    ggplot() +
    geom_line(aes(x = year,
                  y = eviction_filing_rate,
                  group = GEOID,
                  color = county_state)) +
    xlab("Year") + 
    ylab("Eviction Filing Rates") + 
    theme(plot.title = element_text(hjust = 0.5)) +
  theme(plot.subtitle = element_text(hjust = 0.5)) +
  labs(title = paste(hv, "Filing", reg, "Counties"),
       caption = "Data from evictionlab.org") + 
  scale_color_brewer(palette = "Spectral") +
  theme_bw()
}

tplot_south <- reg_plot(ecplot, top_south, "Highest", "South")
bplot_south <- reg_plot(ecplot, bot_south, "Lowest", "South")
tplot_northeast <- reg_plot(ecplot, top_northeast, "Highest", "Northeast")
bplot_northeast <- reg_plot(ecplot, bot_northeast, "Lowest", "Northeast")
tplot_north_cent <- reg_plot(ecplot, top_north_cent, "Highest", "North Central")
bplot_north_cent <- reg_plot(ecplot, bot_north_cent, "Lowest", "North Central")
tplot_west <- reg_plot(ecplot, top_west, "Highest", "West")
bplot_west <- reg_plot(ecplot, bot_west, "Lowest", "West")


tplot_south
tplot_northeast
tplot_north_cent
tplot_west
# grid.arrange(bplot_south, bplot_northeast, bplot_north_cent, bplot_west)
```



```{r static county map - set up, include=FALSE}

pretty_breaks <- c(5, 10, 20, 30, 40, 50, 110)
# find the extremes
minVal <- min(county_all_avgs$avg_filing_rate, na.rm = T)
maxVal <- max(county_all_avgs$avg_filing_rate, na.rm = T)

# compute labels
labels <- c()
brks <- c(minVal, pretty_breaks)
# round the labels (actually, only the extremes)
for(idx in 1:length(brks)){
  labels <- c(labels,round(brks[idx + 1], 2))
}

labels <- labels[1:length(labels)-1]
# define a new variable on the data set just as above
county_all_avgs$brks <- cut(county_all_avgs$avg_filing_rate, 
                     breaks = brks, 
                     include.lowest = TRUE, 
                     labels = labels)

brks_scale <- levels(county_all_avgs$brks)
labels_scale <- rev(brks_scale)

```

```{r map county averages, echo=FALSE,include=FALSE}

ggplot(data = county_all_avgs) +
  geom_sf(aes(fill = brks), color = "black", lwd = 0.01) +
  coord_sf(crs = st_crs(102003)) +
  theme(legend.position = "bottom") +
  scale_fill_manual(values = rev(viridis(8)), 
                  breaks = rev(brks_scale), 
                  labels = labels_scale, 
                  name = "Average Eviction Filing Rate", 
                  guide = guide_legend(
                        direction = "horizontal",
                        keyheight = unit(2, units = "mm"),
                        keywidth = unit(70 / length(labels), units = "mm"),
                        title.position = 'top',
                        title.hjust = 0.5,
                        label.hjust = 1,
                        nrow = 1,
                        byrow = T,
                        reverse = T,
                        label.position = "bottom")) +
  ggtitle("Average Eviction Filing Rate by County") +
  theme(panel.grid.major = element_line(colour = 'transparent'),
        plot.title = element_text(hjust = 0.5),
  axis.title.x=element_blank(), 
  axis.text.x=element_blank(),
  axis.ticks.x=element_blank(),
  axis.title.y=element_blank(), 
  axis.text.y=element_blank(),
  axis.ticks.y=element_blank(),
  panel.background=element_blank(),
  panel.border=element_blank(),
  panel.grid.minor=element_blank(),
  plot.background=element_blank())

```

We then compared some attributes in the highest filing counties versus the lowest filing counties utilizing histograms and density area graphs overlapping the histograms. The attributes that seemed to differ across these two segments were rental costs, percentage of rural population, the percentage of white population, rent burden, and median household income. The top ten filing counties had lower percentages of rural, white population, and higher concentrated areas of rent burden and a larger spread of median income. 

```{r demos_all, echo=FALSE}
# Demographics for top and bottom
top_lists <- c(top_south, top_north_cent, top_northeast, top_west)
bot_lists <- c(bot_south, bot_north_cent, bot_northeast, bot_west)

dense_plot_demos <- function(df, id_list, demog, color_id, demo_name, qual) {
  demog <- sym(demog)
  df %>%
  filter(GEOID %in% id_list) %>%
  group_by(GEOID) %>%
  mutate(avg = (mean(!! demog, na.rm=TRUE))) %>%
  ggplot(aes(x=avg)) + 
  geom_histogram(aes(y=..density..), color="black", fill="white", bins=20) + 
  geom_density(alpha=.5, fill=color_id) + 
  theme_bw() + 
  xlab(demo_name) + 
  ylab("Density") + 
  theme(plot.title = element_text(hjust = 0.5)) +
  labs(title = paste(demo_name, "in", qual, "Filing Counties")) 
}

top_pov <- dense_plot_demos(ecplot, top_lists, "poverty_rate", spectral[1], "Poverty Rate", "Highest")
bot_pov <- dense_plot_demos(ecplot, bot_lists, "poverty_rate", spectral[1], "Poverty Rate", "Lowest")
#grid.arrange(top_pov,bot_pov)

top_rb <- dense_plot_demos(ecplot, top_lists, "rent_burden", spectral[2], "Rent Burden", "Highest")
bot_rb <- dense_plot_demos(ecplot, bot_lists, "rent_burden", spectral[2], "Rent Burden", "Lowest")
grid.arrange(top_rb,bot_rb)


top_pct_wh <- dense_plot_demos(ecplot, top_lists, "pct_white", spectral[3], "% White", "Highest")
bot_pct_wh <- dense_plot_demos(ecplot, bot_lists, "pct_white", spectral[3], "% White", "Lowest")
#grid.arrange(top_pct_wh,bot_pct_wh)


top_pct_n_wh <- dense_plot_demos(ecplot, top_lists, "pct_nonwhite", spectral[4], "% Nonwhite", "Highest")
bot_pct_n_wh <- dense_plot_demos(ecplot, bot_lists, "pct_nonwhite", spectral[4], "% Nonwhite", "Lowest")
grid.arrange(top_pct_n_wh,bot_pct_n_wh)


top_hhi <- dense_plot_demos(ecplot, top_lists, "median_household_income", spectral[5], "Median Household Income", "Highest")
bot_hhi <- dense_plot_demos(ecplot, bot_lists, "median_household_income", spectral[5], "Median Household Income", "Lowest")
#grid.arrange(top_hhi,bot_hhi)


top_uer <- dense_plot_demos(ecplot, top_lists, "unemployment_rate", spectral[6], "Unemployment", "Highest")
bot_uer <- dense_plot_demos(ecplot, bot_lists, "unemployment_rate", spectral[6], "Unemployment", "Lowest")
#grid.arrange(top_uer,bot_uer)


top_ro <- dense_plot_demos(ecplot, top_lists, "pct_renter_occupied", spectral[7], "% Renter Occupied", "Highest")
bot_ro <- dense_plot_demos(ecplot, bot_lists, "pct_renter_occupied", spectral[7], "% Renter Occupied", "Lowest")
grid.arrange(top_ro,bot_ro)


top_rur <- dense_plot_demos(ecplot, top_lists, "Percent_Rural", spectral[8], "% Rural", "Highest")
bot_rur <- dense_plot_demos(ecplot, bot_lists, "Percent_Rural", spectral[8], "% Rural", "Lowest")
grid.arrange(top_rur,bot_rur)


top_gr <- dense_plot_demos(ecplot, top_lists, "median_gross_rent", spectral[9], "Median Gross Rent", "Highest")
bot_gr <- dense_plot_demos(ecplot, bot_lists, "median_gross_rent", spectral[9], "Median Gross Rent", "Lowest")
grid.arrange(top_gr,bot_gr)
```

For our [Shiny app](https://mpuerto.shinyapps.io/Eviction_Shiny/), we wanted to have two main components; a map that the user can use to visualize the eviction filing rate data or percent renter occupied data by state for each year, and a an analysis component that a visitor to the app can use to find eviction filing rate data for a county of their choice, and the ability to easily and compare their selection to other counties with similar demographic make-up. The descriptive stats are time series data and the user is able to look at eviction filing rates and X by state from 2010 to 2016. The county level data has a time series graph that trends eviction filing rates or unemployment rates by year of the county selected from the dropdown menu. In the counties tab it also populates a table with averages of some attributes of that county along with 4 other randomly selected cities pertaining to the same cluster such as rural percentage, monthly gross rent, median income, median property value, some demographic percentages, etc. Using this table the user can compare the average eviction filing rate across the county selected and the randomly four other selected from the same cluster to see if they also share similar eviction rates. Most of the counties were mapped to cluster one, whereas the South makes up the majority of cluster 2, and cluster with the smallest frequency of counties are evenly distributed across regions.

```{r Cluster graphs, echo=FALSE}
grid.arrange(ggplot(na.omit(eviction_county_2010),aes(cluster,fill=region)) + geom_bar() + scale_fill_brewer("Spectral") + theme(plot.title = element_text(hjust = 0.5)) + ggtitle("Freq Count of Regions by Cluster"),eviction_county_2010 %>%
  filter(!(is.na(region))) %>%
  ggplot(aes(cluster)) + 
  geom_bar(aes(fill=region), position="fill") + 
  scale_fill_brewer("Spectral") +
  theme(plot.title = element_text(hjust = 0.5)) +
  labs(title = "% of Regions by Cluster"))
```


After analyzing the Eviction Labs dataset we were able to conclude there may have been some bias and issues within the dataset. The dataset had instances of omitted variable bias. One of them was the information Eviction Labs aggregated from case records did not have demographics or other information of the exact people that were filed against for eviction, except for where the filing occurred which was geocoded by the Eviction Labs from addresses from the case records which then the frequencies were assigned to counties. We had to use Census Bureau data which was a combination of demographic and economic variables at the county level to see if we could find a pattern within eviction filing rates that were filed in the same county across all the counties in the United States during 2010-2016. The makeup/characteristics of the county where the eviction filings occurred were the best estimates on trying to extrapolate patterns across counties. Ideally we would have the demographics from the people evicted. 

The second omitted variable bias were access to data in certain states and/or counties so estimates/imputations were created by the Eviction Lab. According to the Eviction Lab’s methodology report, any states that did not have statewide coverage statistics of county  level eviction data were not included in the calculations. States whose counties were estimated from state level data were Alaska, North Dakota, South Dakota, and Arkansas. There were also counties that had underestimated eviction counts, including counties that were in the urban parts of New York, California, New Jersey, Maryland, etc. Rural areas also experienced data collection difficulties in states such as Kentucky, Louisiana, Tennessee, Wyoming and the District of Columbia. For example in California it was stated in the methodology report that many cases that ended in eviction were not publicly accessible and it was hard to access data as a whole. This solidified our decision to look at eviction filing rates versus actual eviction rates, because data collection can be quite cumbersome across states. Which is why there are higher eviction filing rates and lower eviction rates in some areas such as Prince George’s County in Maryland. Additionally, there were missing data for countiess in specific years only. For instance, the eviction related data for the District of Columbia was missing for three years in the middle of the collection period.

These data omissions noted could impact the conclusions drawn from the dataset, particularly when comparing the eviction-related data among multiple counties. As a result, even in counties with demographic and economic makeups consistent with higher filing rates we may not have the full picture of evictions based on the collection methods and availability of data. However, with the data that was available to us, we can conclude that eviction filing rates positively correlated with higher diversity rates, a larger population, higher rental occupancy, and higher rent burden.

Due to this, although some countiess may have similar demographic and economic makeups which may be consistent with higher eviction filing rates, we may not have the full picture regarding the eviction related data based on the collection methods and availability of data. 

What we found was eviction filing rates correlated positively in counties with  higher diversity rates, higher population, and with higher rental occupancy percentages with higher rental costs.



```{r Distribution of Variables, include=FALSE}

# EVERYTHING BELOW IS EXTRA EDA
eviction_county %>%
  filter(year>2009) %>%
  dplyr::select(-year,-eviction_filings, -evictions,-imputed, -low_flag,-subbed) %>% 
  mutate(GEOID = as.numeric(GEOID)) %>%
  keep(is.numeric) %>%
  group_by(GEOID) %>%
  # Keep only numeric columns
  summarise_all(mean,na.rm=TRUE) %>%
  gather() %>%                             # Convert to key-value pairs
  ggplot(aes(value)) +                     # Plot the values
    facet_wrap(~ key, scales = "free") +   # In separate panels
    geom_density(fill=spectral[1]) +
  theme_minimal() +
  ggtitle("Distribution of Variables Eviction Data 2010-2016")
  
```


```{r gganimate eviction for state,eval=FALSE, include=FALSE}
# look at eviction rate over time per state -- create gganimate
anim_eviction_state <- eviction_state_2010 %>%
  ggplot(aes(x = eviction_filing_rate, y = factor(name,
                                                  levels = rev(levels(factor(name)))))) +
  geom_point(aes(size = population, fill = rent_burden), 
             shape = 21) +
  scale_fill_distiller(palette = "YlGnBu", direction = 1) +
  scale_x_log10(breaks = 2^(-1:7)*1000) +
  scale_size(range = c(1, 20), guide = FALSE) +
  labs(x = "Eviction Rate",
       y = "State",
       fill = "% Rent Burden") +
  transition_states(year, transition_length = 1,
                    state_length = 1)+
  ggtitle("Year showing {closest_state}",
          subtitle = "Frame {frame} of {nframes}")+
  theme_bw() 

anim_eviction_state
```

```{r gganimate eviction for county,eval=FALSE, include=FALSE}
# look at eviction rate over time per top 25 counties -- create gganimate
# this needs to have better formatting for final.

# get top 25 counties with highest average eviction rate
county_top25_eviction <- eviction_county_2010 %>%
  group_by(GEOID) %>%
  summarise(
    avg_rate = mean(eviction_filing_rate, na.rm = TRUE)
  ) %>%
  top_n(25) %>%
  arrange(desc(avg_rate))

# add data for top 25 highest eviction filing rate
top25_counties <- county_top25_eviction %>%
  left_join(eviction_county_2010, by = "GEOID") %>%
  dplyr::select(everything()) %>%
  mutate(name_state = str_c(name,", ",State))


anim_evic_top25_counties <- top25_counties %>%
  ggplot(aes(x = eviction_filing_rate, y = factor(name_state,
                                                  levels = rev(levels(factor(name_state)))))) +
  geom_point(aes(size = population, fill = rent_burden),
             shape = 21) +
   scale_fill_distiller(palette = "YlGnBu", direction = 1) +
  scale_x_log10(breaks = 2^(-1:7)*1000) +
  scale_size(range = c(1, 20), guide = FALSE) +
  labs(x = "Eviction Filing Rate",
       y = "County",
       fill = "% Rent Burden") +
  transition_states(year, transition_length = 1,
                    state_length = 1)+
  ggtitle("Year showing {closest_state}",
          subtitle = "Frame {frame} of {nframes}")+
  theme_bw()

anim_evic_top25_counties 
```

```{r county EDA,eval=FALSE, include=FALSE}
top25_counties %>%
  group_by(parent_location, year) %>%
  count()

# get bottom 100 counties with lowest average eviction rate
county_top100_eviction <- eviction_county_2010 %>%
  group_by(GEOID) %>%
  summarise(
    avg_rate = mean(eviction_filing_rate, na.rm = TRUE)
  ) %>%
  top_n(100) %>%
  arrange(desc(avg_rate))

# add data for lowest 100 highest eviction filing rate
top100_counties <- county_top100_eviction %>%
  left_join(eviction_county_2010, by = "GEOID") %>%
  dplyr::select(everything()) %>%
  mutate(name_state = str_c(name,", ",State))

ggplot(top100_counties, aes(x = pct_renter_occupied, y = eviction_filing_rate)) +
  geom_point(aes(col = State)) +
  ggtitle("Eviction Filing Rate vs. % Renter Occupied
  for Counties With Lowest Eviction Filing Rate")

# get bottom 100 counties with lowest average eviction rate
county_btm100_eviction <- eviction_county_2010 %>%
  group_by(GEOID) %>%
  summarise(
    avg_rate = mean(eviction_filing_rate, na.rm = TRUE)
  ) %>%
  top_n(-100) %>%
  arrange(desc(avg_rate))

# add data for lowest 100 highest eviction filing rate
btm100_counties <- county_btm100_eviction %>%
  left_join(eviction_county_2010, by = "GEOID") %>%
  dplyr::select(everything()) %>%
  mutate(name_state = str_c(name,", ",State))

ggplot(btm100_counties, aes(x = pct_renter_occupied, y = eviction_filing_rate)) +
  geom_point(aes(col = State)) +
  ggtitle("Eviction Filing Rate vs. % Renter Occupied
  for Counties With Lowest Eviction Filing Rate")
```




```{r Create Mapping Application Function,eval=FALSE, include=FALSE}
# Create color schemes
purPal <- colorBin("Reds", domain = state_eviction$eviction_filing_rate, bins = c(0, 5, 10, 20, 30, 40, 50, 100, 120))
blugr <- colorBin("YlGnBu", domain = state_eviction$pct_renter_occupied, n = 6)

# Create popup messages
popup_evic <- paste0("<b>","<center>", state_eviction$name,
                     "</b>","</center>",
                     "<br />Median HH Income: $", state_eviction$median_household_income,
                     "<br />Population: ", state_eviction$population,
                     "<br />Percent Rent Burden: ", state_eviction$rent_burden,
                     "<br />Eviction Filing Rate: ", state_eviction$eviction_filing_rate)
#popup_evic

# Create mapping function
map_maker <- function(x){
  if (x == "Eviction Filing Rates") {
  leaflet() %>% 
  setView(-98.483330, 38.712046, zoom = 4) %>%
  addProviderTiles(providers$CartoDB.Positron) %>%
  addPolygons(data = state_eviction, fillColor = ~purPal(state_eviction$eviction_filing_rate), 
              smoothFactor = 0.2, fillOpacity = .7, weight = 0.2,
              popup = ~popup_evic) %>%
  addLegend(purPal,
             values = state_eviction$eviction_filing_rate,
             position = "bottomleft",
             title = "Eviction Filing Rates")
  }else{
  leaflet() %>% 
  setView(-98.483330, 38.712046, zoom = 4) %>%
  addProviderTiles(providers$CartoDB.Positron) %>%
  addPolygons(data = state_eviction, 
              fillColor = ~blugr(state_eviction$pct_renter_occupied),
              smoothFactor = 0.2, fillOpacity = .7, weight = 0.2,
              popup = ~popup_evic) %>%
  addLegend(blugr,
             values = state_eviction$pct_renter_occupied,
             position = "bottomleft",
             title = "Percent Renter Occupied") }
}
  
x <- "Eviction Filing Rates"
map_maker(x)

```




```{r trends_region_rural, include=FALSE}
# Plot top and bottom counties by region
reg_plot_rural <- function(df, reglist, hv, reg) {
  df %>%
    filter(GEOID %in% reglist) %>%
    ggplot() +
    geom_line(aes(x = year,
                  y = eviction_filing_rate,
                  group = GEOID,
                  color = rural_flag)) +
    xlab("Year") + 
    ylab("Eviction Filing Rates") + 
    theme(plot.title = element_text(hjust = 0.5)) +
  theme(plot.subtitle = element_text(hjust = 0.5)) +
  labs(title = paste(hv, "Filing", reg, "Counties"),
       caption = "Data from evictionlab.org") + 
  scale_color_manual(values=c(spectral[9], spectral[11])) +
  theme_bw()
}

tplot_south_rural <- reg_plot_rural(ecplot, top_south, "Highest", "South")
bplot_south_rural <- reg_plot_rural(ecplot, bot_south, "Lowest", "South")
tplot_northeast_rural <- reg_plot_rural(ecplot, top_northeast, "Highest", "Northeast")
bplot_northeast_rural <- reg_plot_rural(ecplot, bot_northeast, "Lowest", "Northeast")
tplot_north_cent_rural <- reg_plot_rural(ecplot, top_north_cent, "Highest", "North Central")
bplot_north_cent_rural <- reg_plot_rural(ecplot, bot_north_cent, "Lowest", "North Central")
tplot_west_rural <- reg_plot_rural(ecplot, top_west, "Highest", "West")
bplot_west_rural <- reg_plot_rural(ecplot, bot_west, "Lowest", "West")


grid.arrange(tplot_south_rural, tplot_northeast_rural, tplot_north_cent_rural, tplot_west_rural)
grid.arrange(bplot_south_rural, bplot_northeast_rural, bplot_north_cent_rural, bplot_west_rural)
```


```{r plot rates by cluster, echo=FALSE, include=FALSE}
ec1 <- eviction_county_2010 %>% filter(cluster == 1) %>% sample_n(10)
ec2 <- eviction_county_2010 %>% filter(cluster == 2) %>% sample_n(10)
ec3 <- eviction_county_2010 %>% filter(cluster == 3) %>% sample_n(10)

samples <- ec1$GEOID
samples <- append(samples, ec2$GEOID)
samples <- append(samples, ec3$GEOID)
length(samples)

eviction_county_2010 %>%
  filter(GEOID %in% samples) %>%
  ggplot() +
  geom_line(aes(x = year,
                y = eviction_filing_rate, 
                group = GEOID,
                color = cluster)) +
  xlab("Year") +
  ylab("Eviction Filing Rates") +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(plot.subtitle = element_text(hjust = 0.5)) +
  labs(title = "Eviction Filing Rates by Cluster",
       caption = "Data from evictionlab.org") + 
  scale_color_manual(values=c(spectral[4], spectral[9], spectral[11])) +
  theme_bw()
```



# References

Methodology Report: Matthew Desmond, Ashley Gromis, Lavar Edmonds, James
Hendrickson, Katie Krywokulski, Lillian Leung, and Adam Porton. Eviction Lab
Methodology Report: Version 1.0. Princeton: Princeton University, 2018,
www.evictionlab.org/methods.
